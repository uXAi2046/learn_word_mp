<!--pages/quiz/quiz.wxml-->
<view class="quiz-container">
  <!-- ç­”é¢˜æ¨¡å¼é€‰æ‹©ç•Œé¢ -->
  <view class="quiz-mode-selection" wx:if="{{currentPage === 'mode-selection'}}">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <view class="page-header">
      <text class="page-title">ğŸ“ å¼€å§‹ç­”é¢˜</text>
    </view>

    <!-- å¿«é€Ÿç­”é¢˜æ¨¡å¼ -->
    <view class="mode-card" bindtap="startQuickQuiz">
      <view class="mode-header">
        <view class="mode-icon">ğŸš€</view>
        <view class="mode-title">å¿«é€Ÿç­”é¢˜</view>
      </view>
      <view class="mode-features">
        <text class="feature-item">â€¢ å›ºå®š30é¢˜æµ‹è¯•</text>
        <text class="feature-item">â€¢ è¯„ä¼°å½“å‰æ°´å¹³</text>
        <text class="feature-item">â€¢ é¢„è®¡ç”¨æ—¶: 8-12åˆ†é’Ÿ</text>
      </view>
      <view class="mode-button">ç«‹å³å¼€å§‹</view>
    </view>

    <!-- æ— å°½æ¨¡å¼ -->
    <view class="mode-card" bindtap="startEndlessMode">
      <view class="mode-header">
        <view class="mode-icon">â™¾ï¸</view>
        <view class="mode-title">æ— å°½æ¨¡å¼</view>
      </view>
      <view class="mode-features">
        <text class="feature-item">â€¢ æ— é™é¢˜ç›®ç»ƒä¹ </text>
        <text class="feature-item">â€¢ è‡ªç”±æ§åˆ¶èŠ‚å¥</text>
        <text class="feature-item">â€¢ éšæ—¶ç»“æŸæŸ¥çœ‹æˆç»©</text>
      </view>
      <view class="mode-button">å¼€å§‹ç»ƒä¹ </view>
    </view>

    <!-- é«˜çº§è®¾ç½® -->
    <view class="settings-card">
      <view class="settings-header">
        <view class="settings-icon">âš™ï¸</view>
        <view class="settings-title">é«˜çº§è®¾ç½®</view>
      </view>
      <view class="settings-content">
        <view class="setting-item">
          <text class="setting-label">é¢˜å‹åå¥½:</text>
          <picker bindchange="onQuestionTypeChange" value="{{questionTypeIndex}}" range="{{questionTypes}}">
            <view class="picker">{{questionTypes[questionTypeIndex]}} â–¼</view>
          </picker>
        </view>
        <view class="setting-item">
          <text class="setting-label">éš¾åº¦ç­‰çº§:</text>
          <picker bindchange="onDifficultyChange" value="{{difficultyIndex}}" range="{{difficulties}}">
            <view class="picker">{{difficulties[difficultyIndex]}} â–¼</view>
          </picker>
        </view>
        <view class="setting-item">
          <text class="setting-label">è¯æ±‡èŒƒå›´:</text>
          <picker bindchange="onVocabRangeChange" value="{{vocabRangeIndex}}" range="{{vocabRanges}}">
            <view class="picker">{{vocabRanges[vocabRangeIndex]}} â–¼</view>
          </picker>
        </view>
        <view class="setting-item">
          <text class="setting-label">ç­”é¢˜æ—¶é—´:</text>
          <picker bindchange="onTimeLimitChange" value="{{timeLimitIndex}}" range="{{timeLimits}}">
            <view class="picker">{{timeLimits[timeLimitIndex]}} â–¼</view>
          </picker>
        </view>
      </view>
    </view>
  </view>

  <!-- ç­”é¢˜è¿›è¡Œä¸­ç•Œé¢ -->
  <view class="quiz-progress" wx:if="{{currentPage === 'quiz-progress'}}">
    <!-- è¿›åº¦ä¿¡æ¯ -->
    <view class="progress-header" style="--progress-percent: {{progressPercent || 0}}%">
      <text class="progress-info">ç¬¬{{quizProgress.currentQuestion}}/{{quizProgress.totalQuestions}}é¢˜</text>
    </view>
    
    <!-- é¢˜ç›®å¡ç‰‡ -->
    <view class="question-card">
      <!-- é€‰æ‹©é¢˜ -->
      <view class="question-content" wx:if="{{currentQuestionData.type === 'choice'}}">
        <view class="question-type">ğŸ”¤ é€‰æ‹©é¢˜</view>
        <view class="question-word">{{currentQuestionData.word}}</view>
        <view class="question-phonetic" wx:if="{{currentQuestionData.phonetic}}">{{currentQuestionData.phonetic}}</view>
        <view class="play-pronunciation" bindtap="playPronunciation">ğŸ”Š æ’­æ”¾å‘éŸ³</view>
        <view class="question-prompt">è¯·é€‰æ‹©æ­£ç¡®çš„ä¸­æ–‡é‡Šä¹‰:</view>
      </view>

      <!-- å¡«ç©ºé¢˜ -->
      <view class="question-content" wx:if="{{currentQuestionData.type === 'fill'}}">
        <view class="question-type">âœï¸ å¡«ç©ºé¢˜</view>
        <view class="question-meaning">{{currentQuestionData.meaning}}</view>
        <view class="question-prompt">è¯·è¾“å…¥å¯¹åº”çš„è‹±æ–‡å•è¯:</view>
        <input class="answer-input" placeholder="è¯·è¾“å…¥ç­”æ¡ˆ" value="{{userAnswer}}" bindinput="onAnswerInput" />
        <view class="question-hint" wx:if="{{currentQuestionData.hint}}">ğŸ’¡ æç¤º: {{currentQuestionData.hint}}</view>
      </view>
    </view>

    <!-- é€‰æ‹©é¢˜é€‰é¡¹ -->
    <view class="options-container" wx:if="{{currentQuestionData.type === 'choice'}}">
      <view class="option-item {{selectedOption === item.id ? 'selected' : ''}}" 
            wx:for="{{currentQuestionData.options}}" 
            wx:key="id"
            bindtap="selectOption"
            data-option="{{item.id}}">
        <text class="option-label">{{item.id}}</text>
        <text class="option-text">{{item.text}}</text>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="action-buttons">
      <view class="btn btn-primary" bindtap="submitAnswer">
        {{showFeedback ? 'ä¸‹ä¸€é¢˜' : 'æäº¤ç­”æ¡ˆ'}}
      </view>
      <view class="btn btn-secondary" bindtap="skipQuestion" wx:if="{{currentQuestionData.type === 'fill' && !showFeedback}}">
        è·³è¿‡æ­¤é¢˜
      </view>
      <view class="btn btn-secondary" bindtap="getHint" wx:if="{{currentQuestionData.type === 'fill' && !showFeedback}}">
        éœ€è¦æç¤º
      </view>
    </view>

    <!-- ç­”æ¡ˆåé¦ˆ -->
    <view class="answer-feedback" wx:if="{{showFeedback}}">
      <view class="feedback-header {{isCorrect ? 'correct' : 'incorrect'}}">
        <text class="feedback-icon">{{isCorrect ? 'âœ…' : 'âŒ'}}</text>
        <text class="feedback-text">{{isCorrect ? 'å›ç­”æ­£ç¡®!' : 'å›ç­”é”™è¯¯'}}</text>
      </view>
      
      <view class="word-detail">
        <view class="word-info">
          <text class="word-name">{{currentQuestionData.word}}</text>
          <text class="word-phonetic" wx:if="{{currentQuestionData.phonetic}}">{{currentQuestionData.phonetic}}</text>
          <text class="word-meaning">{{currentQuestionData.meaning}}</text>
        </view>

        <view class="example-sentence" wx:if="{{currentQuestionData.exampleSentence}}">
          <text class="example-label">ğŸ“ ä¾‹å¥:</text>
          <text class="example-en">{{currentQuestionData.exampleSentence.en}}</text>
          <text class="example-zh">{{currentQuestionData.exampleSentence.zh}}</text>
        </view>

        <view class="wrong-answer" wx:if="{{!isCorrect}}">
          <text class="wrong-label">ä½ çš„ç­”æ¡ˆ: {{selectedOption || userAnswer}}</text>
          <text class="correct-label">æ­£ç¡®ç­”æ¡ˆ: {{currentQuestionData.correctAnswer}}</text>
        </view>

        <view class="explanation" wx:if="{{currentQuestionData.explanation}}">
          <text class="explanation-label">ğŸ’¡ è§£é‡Š:</text>
          <text class="explanation-content">{{currentQuestionData.explanation}}</text>
        </view>

        <view class="error-collection" wx:if="{{!isCorrect}}">
          <text class="collection-text">ğŸ“š å·²åŠ å…¥é”™é¢˜æœ¬</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ç­”é¢˜ç»“æœé¡µé¢ -->
  <view class="quiz-result" wx:if="{{currentPage === 'quiz-result'}}">
    <view class="result-header">
      <text class="result-title">ğŸ‰ ç­”é¢˜å®Œæˆ</text>
    </view>

    <!-- æˆç»©å¡ç‰‡ -->
    <view class="score-card">
      <view class="score-title">ğŸ† æœ¬æ¬¡æˆç»©</view>
      <view class="score-stats">
        <text class="accuracy-stat">æ­£ç¡®ç‡: {{Math.round(correctCount/totalQuestions*100)}}%</text>
        <text class="time-stat">ç”¨æ—¶: {{formatTime(totalTime)}}</text>
        <text class="correct-stat">ç­”å¯¹: {{correctCount}}/{{totalQuestions}}é¢˜</text>
      </view>
      <view class="star-rating">
        <text class="stars" wx:for="{{starRating}}" wx:key="index">{{item ? 'â­' : 'â˜†'}}</text>
        <text class="rating-text">({{starCount}}æ˜Ÿ)</text>
      </view>
    </view>

    <!-- è¯¦ç»†åˆ†æ -->
    <view class="analysis-card">
      <view class="analysis-title">ğŸ“Š è¯¦ç»†åˆ†æ</view>
      <view class="analysis-content">
        <view class="pos-analysis">
          <text class="analysis-label">è¯æ€§åˆ†å¸ƒ:</text>
          <view class="pos-stats">
            <text class="pos-item" wx:for="{{posStats}}" wx:key="type">
              {{item.name}}: {{item.correct}}/{{item.total}} {{item.correct === item.total ? 'âœ“' : ''}}
            </text>
          </view>
        </view>
        <view class="error-summary" wx:if="{{quizResult.analysis.errorCount > 0}}">
          <text class="error-label">é”™é¢˜: {{quizResult.analysis.errorCount}}ä¸ª</text>
          <text class="error-link" bindtap="viewErrors">æŸ¥çœ‹è¯¦æƒ… â†’</text>
        </view>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="result-actions">
      <view class="btn btn-primary" bindtap="restartQuiz">å†æ¥ä¸€æ¬¡</view>
      <view class="btn btn-secondary" bindtap="viewErrors" wx:if="{{quizResult.analysis.errorCount > 0}}">æŸ¥çœ‹é”™é¢˜</view>
      <view class="btn btn-secondary" bindtap="backToHome">è¿”å›é¦–é¡µ</view>
    </view>
  </view>
</view>