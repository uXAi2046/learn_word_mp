<!--pages/reading/reading.wxml-->
<view class="container">
  <!-- å¯¼èˆªæ  -->
  <view class="nav-bar">
    <view class="back-btn" bindtap="onBack">
      <text class="back-icon">â†</text>
      <text>è¿”å›</text>
    </view>
    <view class="help-btn" bindtap="onShowHelp">
      <text>å¸®åŠ©</text>
    </view>
  </view>

  <!-- å­¦ä¹ è¿›åº¦ -->
  <view class="progress-card">
    <view class="progress-header">
      <text class="progress-title">é˜…è¯»ç†è§£</text>
      <text class="progress-count">{{currentIndex + 1}}/{{totalWords}}</text>
    </view>
    <view class="progress-bar">
      <view class="progress-fill" style="width: {{progress}}%"></view>
    </view>
    <text class="progress-text">å·²å®Œæˆ {{completedCount}} ä¸ªå•è¯</text>
  </view>

  <!-- å•è¯å±•ç¤ºåŒºåŸŸ -->
  <view class="word-display">
    <text class="word-text">{{currentWord.word}}</text>
    <text class="word-phonetic">{{currentWord.phonetic}}</text>
    <view class="audio-controls">
      <view class="audio-btn {{isPlaying ? 'playing' : ''}}" bindtap="onPlayAudio">
        <text class="audio-icon">ğŸ”Š</text>
        <text>å‘éŸ³</text>
      </view>
    </view>
    <text class="play-count">æ’­æ”¾æ¬¡æ•°: {{playCount}}</text>
  </view>

  <!-- é˜…è¯»ç†è§£åŒºåŸŸ -->
  <view class="reading-practice">
    <!-- é˜…è¯»æ¨¡å¼é€‰æ‹© -->
    <view class="reading-modes">
      <view class="mode-tab {{readingMode === 'context' ? 'active' : ''}}" bindtap="onSelectMode" data-mode="context">
        <text class="mode-icon">ğŸ“–</text>
        <text>è¯­å¢ƒé˜…è¯»</text>
      </view>
      <view class="mode-tab {{readingMode === 'comprehension' ? 'active' : ''}}" bindtap="onSelectMode" data-mode="comprehension">
        <text class="mode-icon">ğŸ§ </text>
        <text>ç†è§£æµ‹è¯•</text>
      </view>
      <view class="mode-tab {{readingMode === 'vocabulary' ? 'active' : ''}}" bindtap="onSelectMode" data-mode="vocabulary">
        <text class="mode-icon">ğŸ“</text>
        <text>è¯æ±‡æ ‡æ³¨</text>
      </view>
    </view>

    <!-- è¯­å¢ƒé˜…è¯»æ¨¡å¼ -->
    <view class="context-mode" wx:if="{{readingMode === 'context'}}">
      <view class="passage-container">
        <view class="passage-header">
          <text class="passage-title">{{currentPassage.title}}</text>
          <text class="passage-level">éš¾åº¦: {{currentPassage.level}}</text>
        </view>
        <view class="passage-content">
          <text class="passage-text" bindtap="onSelectText" data-text="{{currentPassage.content}}">{{currentPassage.content}}</text>
        </view>
        <view class="passage-translation" wx:if="{{showTranslation}}">
          <text class="translation-text">{{currentPassage.translation}}</text>
        </view>
      </view>
      
      <view class="reading-tools">
        <view class="tool-btn" bindtap="onToggleTranslation">
          <text class="tool-icon">ğŸŒ</text>
          <text>{{showTranslation ? 'éšè—' : 'æ˜¾ç¤º'}}ç¿»è¯‘</text>
        </view>
        <view class="tool-btn" bindtap="onHighlightWord">
          <text class="tool-icon">ğŸ–ï¸</text>
          <text>é«˜äº®å•è¯</text>
        </view>
        <view class="tool-btn" bindtap="onPlayPassage">
          <text class="tool-icon">ğŸµ</text>
          <text>æœ—è¯»æ–‡ç« </text>
        </view>
      </view>

      <!-- è¯æ±‡è§£é‡Šå¼¹çª— -->
      <view class="word-popup" wx:if="{{showWordPopup}}" style="left: {{popupPosition.x}}px; top: {{popupPosition.y}}px;">
        <view class="popup-content">
          <text class="popup-word">{{selectedWord.word}}</text>
          <text class="popup-phonetic">{{selectedWord.phonetic}}</text>
          <text class="popup-meaning">{{selectedWord.meaning}}</text>
          <view class="popup-actions">
            <view class="popup-btn" bindtap="onPlayWordAudio">
              <text>ğŸ”Š</text>
            </view>
            <view class="popup-btn" bindtap="onAddToCollection">
              <text>â­</text>
            </view>
            <view class="popup-btn" bindtap="onClosePopup">
              <text>âœ•</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ç†è§£æµ‹è¯•æ¨¡å¼ -->
    <view class="comprehension-mode" wx:if="{{readingMode === 'comprehension'}}">
      <view class="question-container">
        <text class="question-number">é—®é¢˜ {{currentQuestionIndex + 1}}/{{questions.length}}</text>
        <text class="question-text">{{currentQuestion.question}}</text>
      </view>

      <view class="options-container">
        <view class="option-item {{selectedOption === index ? 'selected' : ''}} {{showResult && index === currentQuestion.correctAnswer ? 'correct' : ''}} {{showResult && selectedOption === index && index !== currentQuestion.correctAnswer ? 'incorrect' : ''}}" 
              wx:for="{{currentQuestion.options}}" 
              wx:key="index"
              bindtap="onSelectOption" 
              data-index="{{index}}">
          <text class="option-label">{{['A', 'B', 'C', 'D'][index]}}.</text>
          <text class="option-text">{{item}}</text>
        </view>
      </view>

      <view class="question-explanation" wx:if="{{showResult && currentQuestion.explanation}}">
        <text class="explanation-title">è§£æ:</text>
        <text class="explanation-text">{{currentQuestion.explanation}}</text>
      </view>
    </view>

    <!-- è¯æ±‡æ ‡æ³¨æ¨¡å¼ -->
    <view class="vocabulary-mode" wx:if="{{readingMode === 'vocabulary'}}">
      <view class="annotation-instruction">
        <text class="instruction-title">è¯æ±‡æ ‡æ³¨ç»ƒä¹ </text>
        <text class="instruction-text">è¯·åœ¨ä¸‹é¢çš„æ–‡ç« ä¸­æ‰¾å‡ºå¹¶æ ‡æ³¨ç›®æ ‡å•è¯ "{{currentWord.word}}"</text>
      </view>

      <view class="annotation-passage">
        <view class="annotated-text">
          <text class="text-segment {{item.isTarget ? 'target-word' : ''}} {{item.isAnnotated ? 'annotated' : ''}}" 
                wx:for="{{annotationText}}" 
                wx:key="index"
                bindtap="onAnnotateWord" 
                data-index="{{index}}">{{item.text}}</text>
        </view>
      </view>

      <view class="annotation-stats">
        <view class="stat-item">
          <text class="stat-label">å·²æ ‡æ³¨:</text>
          <text class="stat-value">{{annotatedCount}}</text>
        </view>
        <view class="stat-item">
          <text class="stat-label">ç›®æ ‡æ•°é‡:</text>
          <text class="stat-value">{{targetCount}}</text>
        </view>
        <view class="stat-item">
          <text class="stat-label">å‡†ç¡®ç‡:</text>
          <text class="stat-value">{{accuracy}}%</text>
        </view>
      </view>

      <view class="annotation-actions">
        <view class="reset-btn" bindtap="onResetAnnotation">
          <text class="btn-icon">ğŸ”„</text>
          <text>é‡ç½®</text>
        </view>
        <view class="check-btn" bindtap="onCheckAnnotation">
          <text class="btn-icon">âœ“</text>
          <text>æ£€æŸ¥</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æ“ä½œæŒ‰é’® -->
  <view class="action-buttons">
    <view class="hint-btn" bindtap="onShowHint">
      <text>ğŸ’¡ æç¤º</text>
    </view>
    <view class="submit-btn" bindtap="onSubmitAnswer">
      <text>{{readingMode === 'context' ? 'å®Œæˆé˜…è¯»' : readingMode === 'comprehension' ? 'æäº¤ç­”æ¡ˆ' : 'å®Œæˆæ ‡æ³¨'}}</text>
    </view>
    <view class="skip-btn" bindtap="onSkipWord">
      <text>è·³è¿‡</text>
    </view>
  </view>

  <!-- é˜…è¯»ç»Ÿè®¡ -->
  <view class="stats-card">
    <text class="stats-title">é˜…è¯»ç»Ÿè®¡</text>
    <view class="stats-grid">
      <view class="stat-item">
        <text class="stat-value">{{stats.correctCount}}</text>
        <text class="stat-label">æ­£ç¡®</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{stats.incorrectCount}}</text>
        <text class="stat-label">é”™è¯¯</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{stats.accuracy}}%</text>
        <text class="stat-label">å‡†ç¡®ç‡</text>
      </view>
    </view>
  </view>
</view>

<!-- ç»“æœå¼¹çª— -->
<view class="result-modal" wx:if="{{showResultModal}}">
  <view class="result-content">
    <text class="result-icon {{isCorrect ? 'correct' : 'incorrect'}}">{{isCorrect ? 'âœ“' : 'âœ—'}}</text>
    <text class="result-title {{isCorrect ? 'correct' : 'incorrect'}}">{{isCorrect ? 'å›ç­”æ­£ç¡®!' : 'å›ç­”é”™è¯¯!'}}</text>
    <text class="result-word">{{currentWord.word}}</text>
    <text class="result-meaning">{{currentWord.meaning}}</text>
    
    <view class="reading-analysis" wx:if="{{!isCorrect}}">
      <text class="analysis-title">é”™è¯¯åˆ†æ:</text>
      <text class="analysis-item">â€¢ {{errorAnalysis.reason}}</text>
      <text class="analysis-item">â€¢ {{errorAnalysis.suggestion}}</text>
    </view>

    <view class="result-actions">
      <view class="play-audio-btn" bindtap="onPlayResultAudio">
        <text class="btn-icon">ğŸ”Š</text>
        <text>å‘éŸ³</text>
      </view>
      <view class="next-btn" bindtap="onNextWord">
        <text class="btn-icon">â†’</text>
        <text>ä¸‹ä¸€ä¸ª</text>
      </view>
    </view>
  </view>
</view>

<!-- å®Œæˆé˜…è¯»å¼¹çª— -->
<view class="complete-modal" wx:if="{{showCompleteModal}}">
  <view class="complete-content">
    <text class="complete-icon">ğŸ‰</text>
    <text class="complete-title">é˜…è¯»ç»ƒä¹ å®Œæˆ!</text>
    
    <view class="complete-stats">
      <view class="complete-stat">
        <text class="stat-name">æ€»å•è¯æ•°:</text>
        <text class="stat-data">{{totalWords}}</text>
      </view>
      <view class="complete-stat">
        <text class="stat-name">æ­£ç¡®æ•°é‡:</text>
        <text class="stat-data">{{stats.correctCount}}</text>
      </view>
      <view class="complete-stat">
        <text class="stat-name">é”™è¯¯æ•°é‡:</text>
        <text class="stat-data">{{stats.incorrectCount}}</text>
      </view>
      <view class="complete-stat">
        <text class="stat-name">å‡†ç¡®ç‡:</text>
        <text class="stat-data">{{stats.accuracy}}%</text>
      </view>
      <view class="complete-stat">
        <text class="stat-name">é˜…è¯»æ—¶é—´:</text>
        <text class="stat-data">{{readingTime}}</text>
      </view>
    </view>

    <view class="achievements">
      <text class="achievements-title">è·å¾—æˆå°±</text>
      <view class="achievement-list">
        <view class="achievement-item" wx:for="{{achievements}}" wx:key="index">
          <text class="achievement-icon">{{item.icon}}</text>
          <text>{{item.name}}</text>
        </view>
      </view>
    </view>

    <view class="complete-actions">
      <view class="restart-btn" bindtap="onRestartReading">
        <text class="btn-icon">ğŸ”„</text>
        <text>é‡æ–°å¼€å§‹</text>
      </view>
      <view class="back-detail-btn" bindtap="onBackToDetail">
        <text class="btn-icon">ğŸ“š</text>
        <text>è¿”å›è¯¦æƒ…</text>
      </view>
    </view>
  </view>
</view>

<!-- å¸®åŠ©è¯´æ˜å¼¹çª— -->
<view class="help-modal" wx:if="{{showHelpModal}}">
  <view class="help-content">
    <text class="help-title">é˜…è¯»ç†è§£å¸®åŠ©</text>
    
    <view class="help-section">
      <text class="help-subtitle">è¯­å¢ƒé˜…è¯»æ¨¡å¼</text>
      <text class="help-text">â€¢ åœ¨çœŸå®è¯­å¢ƒä¸­å­¦ä¹ å•è¯ç”¨æ³•</text>
      <text class="help-text">â€¢ ç‚¹å‡»æ–‡ç« ä¸­çš„å•è¯æŸ¥çœ‹é‡Šä¹‰</text>
      <text class="help-text">â€¢ ä½¿ç”¨å·¥å…·æ åŠŸèƒ½è¾…åŠ©ç†è§£</text>
    </view>

    <view class="help-section">
      <text class="help-subtitle">ç†è§£æµ‹è¯•æ¨¡å¼</text>
      <text class="help-text">â€¢ å›ç­”ä¸æ–‡ç« å†…å®¹ç›¸å…³çš„é—®é¢˜</text>
      <text class="help-text">â€¢ æµ‹è¯•å¯¹å•è¯å’Œè¯­å¢ƒçš„ç†è§£</text>
      <text class="help-text">â€¢ æŸ¥çœ‹è¯¦ç»†çš„ç­”æ¡ˆè§£æ</text>
    </view>

    <view class="help-section">
      <text class="help-subtitle">è¯æ±‡æ ‡æ³¨æ¨¡å¼</text>
      <text class="help-text">â€¢ åœ¨æ–‡ç« ä¸­æ‰¾å‡ºå¹¶æ ‡æ³¨ç›®æ ‡å•è¯</text>
      <text class="help-text">â€¢ æé«˜å•è¯è¯†åˆ«å’Œå®šä½èƒ½åŠ›</text>
      <text class="help-text">â€¢ å®æ—¶æŸ¥çœ‹æ ‡æ³¨å‡†ç¡®ç‡</text>
    </view>

    <view class="help-close" bindtap="onCloseHelp">
      <text>çŸ¥é“äº†</text>
    </view>
  </view>
</view>